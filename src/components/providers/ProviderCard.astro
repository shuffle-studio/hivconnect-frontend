---
import type { Provider } from '../../types/provider';

interface Props {
  provider: Provider;
}

const { provider } = Astro.props;

// Get primary location for display
const primaryLocation = provider.locations[0];

// Provider location images mapping
const locationImages: { [key: string]: string } = {
  'eric-chandler-health-center': '/HIV Treatment Website/Eric B. Chandler Health Center.png',
  'zufall-health': '/HIV Treatment Website/zufall_photo.png',
  'zufall-mobile-unit': '/HIV Treatment Website/zufall_photo.png',
  'rwj-aids-program': '/HIV Treatment Website/RWJ Medical School AIDS Program Location.png',
  'raritan-bay-medical-center': '/HIV Treatment Website/HMH Raritan Bay Location.png',
  'hyacinth-aids-foundation': '/HIV Treatment Website/Hyacinth AIDS Foundation 1200.png',
  'central-jersey-legal-services': '/HIV Treatment Website/Central Jersey Legal Services.png',
  'planned-parenthood-nj': '/HIV Treatment Website/Planned Parenthood - New Brunswick.png',
  'cvs-pharmacy': '/HIV Treatment Website/CVS Minute Clinic.png',
  'nbcc': '/HIV Treatment Website/New Brunswick Counseling Center.png',
  'somerset-treatment-services': '/HIV Treatment Website/Somerset Treatment Services.png',
  'woodbridge-health-dept': '/HIV Treatment Website/Woodbridge Health Department .jpeg',
  'elijahs-promise': '/HIV Treatment Website/Elijah\'s Promise Location.png',
  'vnahg': '/HIV Treatment Website/90_eas_main.psd_with_parking.jpg',
  'legal-services-nwj-hunterdon': '/HIV Treatment Website/Legal Services of Northwest Jersey.png',
  'legal-services-nwj-somerset': '/HIV Treatment Website/Legal Services of Northwest Jersey (Somerset).png',
  'mcat-transportation': '/HIV Treatment Website/Middlesex County Area Transit.png'
};

const locationImage = locationImages[provider.id];

// Provider type explanations
const providerTypeInfo: { [key: string]: { full: string; description: string } } = {
  'FQHC': {
    full: 'Federally Qualified Health Center',
    description: 'Community-based healthcare provider that receives federal funding to provide comprehensive primary care services to underserved populations'
  },
  'ASO': {
    full: 'AIDS Service Organization',
    description: 'Non-profit organization specifically dedicated to providing HIV/AIDS support services, advocacy, and community programs'
  },
  'Community Health Center': {
    full: 'Community Health Center',
    description: 'Healthcare facility that provides comprehensive primary care services to all patients regardless of ability to pay'
  },
  'Private Practice': {
    full: 'Private Medical Practice',
    description: 'Privately-owned medical practice providing specialized HIV care and treatment services'
  },
  'Hospital': {
    full: 'Hospital System',
    description: 'Hospital-based healthcare system providing comprehensive medical services including HIV specialty care'
  }
};

const typeInfo = providerTypeInfo[provider.type] || { full: provider.type, description: 'Healthcare provider' };

// Count available services
const serviceCount = Object.values(provider.services).reduce((count, category) => {
  return count + Object.values(category).filter(Boolean).length;
}, 0);

// Format hours for display
function formatHours(hours: any) {
  const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const today = dayNames[new Date().getDay()];
  const todayHours = hours[today];
  if (!todayHours) return 'Closed today';
  return `Open ${todayHours.open} - ${todayHours.close}`;
}
---

<div class="card hover:shadow-xl transition-all duration-300 border-l-4 border-primary-500 overflow-hidden">
  <!-- Location Photo -->
  {locationImage && (
    <div class="w-full h-32 -mx-6 -mt-6 mb-4">
      <img 
        src={locationImage} 
        alt={`${provider.name} location`}
        class="w-full h-full object-cover"
        loading="lazy"
      />
    </div>
  )}
  
  <div class="flex justify-between items-start mb-4">
    <div class="flex-1">
      <h3 class="text-xl font-semibold text-gray-900 mb-2">
        <a href={`/providers/${provider.id}`} class="hover:text-primary-600 transition-colors">
          {provider.name}
        </a>
      </h3>
      <div class="flex flex-wrap gap-2 mb-3">
        <span 
          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary-100 text-secondary-800 cursor-help" 
          title={`${typeInfo.full}: ${typeInfo.description}`}
        >
          {typeInfo.full}
        </span>
        {provider.ryan_white_parts.map(part => (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
            Ryan White Part {part}
          </span>
        ))}
        {provider.featured && (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success-100 text-success-800">
            Featured Provider
          </span>
        )}
      </div>
    </div>
  </div>

  {provider.description && (
    <p class="text-gray-600 mb-4">{provider.description}</p>
  )}

  <!-- Location Info -->
  <div class="mb-4">
    <div class="flex items-start space-x-2 text-sm text-gray-600 mb-2">
      <svg class="w-4 h-4 mt-0.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <div>
        <p>{primaryLocation.address}</p>
        <p>{primaryLocation.city}, {primaryLocation.county.charAt(0).toUpperCase() + primaryLocation.county.slice(1)} County {primaryLocation.zip_code}</p>
      </div>
    </div>
    
    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-2">
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span>{formatHours(primaryLocation.hours)}</span>
    </div>

    <div class="flex items-center space-x-2 text-sm text-gray-600">
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
      </svg>
      <a href={`tel:${provider.contact.phone}`} class="hover:text-primary-600 transition-colors">
        {provider.contact.phone}
      </a>
    </div>
  </div>

  <!-- Walk-in / Appointment Badge -->
  {provider.walk_in_accepted !== undefined && (
    <div class="mb-4">
      {provider.walk_in_accepted ? (
        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-success-50 text-success-700 border border-success-200">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Walk-ins Welcome
        </span>
      ) : (
        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-secondary-50 text-secondary-700 border border-secondary-200">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Appointment Required
        </span>
      )}
    </div>
  )}

  <!-- Key Services -->
  <div class="mb-4">
    <h4 class="text-sm font-medium text-gray-900 mb-2">Key Services Available:</h4>
    <div class="flex flex-wrap gap-1">
      {provider.services.medical_care.hiv_treatment && (
        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-primary-50 text-primary-700">
          HIV Treatment
        </span>
      )}
      {provider.services.prevention.hiv_testing && (
        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-secondary-50 text-secondary-700">
          HIV Testing
        </span>
      )}
      {provider.services.medical_care.prep_services && (
        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-success-50 text-success-700">
          PrEP Services
        </span>
      )}
      {provider.services.support_services.case_management && (
        <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-warning-50 text-warning-700">
          Case Management
        </span>
      )}
      <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-600">
        +{serviceCount - 4} more services
      </span>
    </div>
  </div>

  <!-- Accessibility & Languages -->
  <div class="flex justify-between items-center pt-4 border-t border-gray-200">
    <div class="flex items-center space-x-4 text-xs text-gray-500">
      {primaryLocation.accessibility.includes('wheelchair') && (
        <span class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
          </svg>
          Accessible
        </span>
      )}
      {provider.languages.length > 1 && (
        <span class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd" />
          </svg>
          {provider.languages.join(', ')}
        </span>
      )}
    </div>
    
    <div class="flex space-x-2">
      <a href={`tel:${provider.contact.phone}`} class="btn-primary text-sm py-2 px-4">
        Call Now
      </a>
      <a href={`/providers/${provider.id}`} class="btn-outline text-sm py-2 px-4">
        View Details
      </a>
    </div>
  </div>
</div>